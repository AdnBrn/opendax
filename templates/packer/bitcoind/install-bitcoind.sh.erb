#!/bin/bash

set -xe

BITCOIN_VERSION="0.18.0"
USER_NAME="bitcoin"
USER_HOME="/home/${USER_NAME}"
BLOCKCHAIN_BUCKET="cryptonodes-blockchain"

cat <<EOT >> /etc/environment
export LANG=en_US.utf-8
export LC_ALL=en_US.utf-8
EOT

# Bash functions, which will be executed in the end of this script.
# Gives ability to refactor this script faster

# Install requirements/dependencies
function prepare_system {
  yum upgrade -y
  yum install -y epel-release
  yum install -y git curl wget pwgen vim htop gcc python-devel\
                 python-setuptools python-pip redhat-rpm-config $@
  pip install -U crcmod
}

# Install bitcoin command line interface to run bitcoind
function install_bitcoin {
  url="https://bitcoin.org/bin/bitcoin-core-${BITCOIN_VERSION}/\
       bitcoin-${BITCOIN_VERSION}-x86_64-linux-gnu.tar.gz"
  url=$(tr -d ' ' <<< "$url")

  wget $url -O bitcoin.tar.gz
  tar -xf bitcoin.tar.gz && mv bitcoin-${BITCOIN_VERSION}/bin/* /usr/local/sbin

  # Delete all files used for bitcoind installation
  rm -rf bitcoin-${BITCOIN_VERSION} bitcoin.tar.gz
}

# Copy bitcoin and bitcoind configuration files
function copy_resources {
  mkdir -p ${USER_HOME}/.bitcoin
  cp /tmp/bitcoind/bitcoin.conf ${USER_HOME}/.bitcoin
  cp /tmp/bitcoind/bitcoind.service /usr/lib/systemd/system/bitcoind.service
}

# Create a user and a group and change the file ownership
function init_user {
  chown -R ${USER_NAME}:${USER_NAME} ${USER_HOME}
}

prepare_system

install_bitcoin

copy_resources

init_user

systemctl enable bitcoind
